# RestorePoint Demo
# Provision and Deploy a simple HTML web application

trigger: none

pool: Default

variables:
- group: RestorePoint-Demo

stages:
- stage: provisionAKS
  displayName: Provision an AKS cluster
  jobs:
    - job: provision
      displayName: Provision AKS cluster
      steps:
      - task: TerraformInstaller@0
        inputs:
          terraformVersion: 'latest'
        displayName: Install Terraform
      
      - task: replacetokens@5
        inputs:
          targetFiles: '**/*.tf'
          encoding: 'auto'
          tokenPattern: 'azpipelines'
          writeBOM: true
          actionOnMissing: 'warn'
          keepToken: false
          actionOnNoFiles: 'continue'
          enableTransforms: false
          enableRecursion: false
          useLegacyPattern: false
          enableTelemetry: true
        displayName: Replace Tokens

      - script: |
          cd $(System.DefaultWorkingDirectory)/Terraform
          terraform init
        displayName: Terraform Initialization
      
      - script: |
          cd $(System.DefaultWorkingDirectory)/Terraform
          terraform plan -out=plan.out
        displayName: Terraform Plan

      - task: ManualValidation@0
        inputs:
          notifyUsers: 'abdullah.safi44@gmail.com'
        displayName: Validate Terraform Plan

      - script: |
          cd $(System.DefaultWorkingDirectory)/Terraform
          terraform apply plan.out
        displayName: Terraform Apply

- stage: deployApp
  displayName: Deploy Nginx deployment
  dependsOn: provisionAKS
  jobs:
    - job: deploy
      displayName: Deploy Manifest files
      steps:
        - task: KubectlInstaller@0
          inputs:
            kubectlVersion: 'latest'
          displayName: Install Kubectl
        